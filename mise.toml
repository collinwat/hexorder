[tools]
gitleaks = "latest"
lefthook = "latest"
"git-lfs" = "latest"
"git-cliff" = "latest"
prettier = "latest"
"aqua:EmbarkStudios/cargo-deny" = "latest"
typos = "latest"
taplo = "latest"
"cargo:bacon" = "latest"

# --- Fix tasks (auto-fix) ---

[tasks."fix:fmt"]
description = "Format Rust code"
run = "cargo fmt --all"

[tasks."fix:taplo"]
description = "Format TOML files"
run = "taplo fmt"

[tasks."fix:prettier"]
description = "Format all files with Prettier"
run = "prettier --write ."

[tasks."fix:prettier:markdown"]
description = "Format markdown files with Prettier"
run = "prettier --write '**/*.md'"

[tasks."fix:typos"]
description = "Fix typos in source code"
run = "typos -w"

[tasks.fix]
description = "Run all fixers"
depends = [ "fix:fmt", "fix:taplo", "fix:prettier", "fix:typos" ]

# --- Check tasks (lint / verify) ---

[tasks."check:fmt"]
description = "Check Rust formatting"
run = "cargo fmt --all -- --check"

[tasks."check:clippy"]
description = "Run clippy lints"
run = "cargo clippy --all-targets"

[tasks."check:test"]
description = "Run all tests"
run = "cargo test"

[tasks."check:deny"]
description = "Audit dependencies"
run = "cargo deny check"

[tasks."check:typos"]
description = "Check for typos"
run = "typos"

[tasks."check:taplo"]
description = "Check TOML formatting"
run = "taplo fmt --check"

[tasks."check:boundary"]
description = "Check no cross-feature internal imports"
run = """
violations=$(grep -rn 'use crate::' src/ --include='*.rs' | grep -v contracts | grep -v 'mod tests' | grep -v tests.rs | grep -v 'use crate::contracts' || true)
if [ -n "$violations" ]; then
  echo "ERROR: Cross-feature import boundary violations found:"
  echo "$violations"
  exit 1
fi
echo "No boundary violations found."
"""

[tasks."check:unwrap"]
description = "Check no unwrap() in production code"
run = """
violations=$(grep -rn '\\.unwrap()' src/ --include='*.rs' | grep -v tests.rs | grep -v 'mod tests' | grep -v '#\\[cfg(test)\\]' | grep -v '#\\[test\\]' || true)
if [ -n "$violations" ]; then
  echo "ERROR: unwrap() found in production code (test files exempt):"
  echo "$violations"
  exit 1
fi
echo "No unwrap() in production code."
"""

[tasks.check]
description = "Run all checks"
depends = [
  "check:fmt",
  "check:clippy",
  "check:test",
  "check:deny",
  "check:typos",
  "check:taplo",
  "check:boundary",
  "check:unwrap",
]

[tasks."check:audit"]
description = "Full constitution audit (all automated checks)"
depends = [ "check" ]

# --- Workflow tasks ---

[tasks.changelog]
description = "Preview unreleased changelog"
run = "git cliff --unreleased"

[tasks."changelog:generate"]
description = "Regenerate CHANGELOG.md from all tags"
run = "git cliff --output CHANGELOG.md"

[tasks.setup]
description = "First-time project setup (tools, hooks, LFS)"
run = """
mise install
git lfs install
lefthook install
"""

[tasks.handoff]
description = "Session handoff — dump context for resuming work"
run = """
echo "=== Worktrees ==="
git worktree list
echo ""
echo "=== Current Branch ==="
git branch --show-current
echo ""
echo "=== Working Tree Status ==="
git status --short
echo ""
echo "=== Branch Commits (since main) ==="
git log --oneline main..HEAD 2>/dev/null || echo "(on main — no feature branch commits)"
echo ""
echo "=== Changed Files (since main) ==="
git diff main..HEAD --stat 2>/dev/null || echo "(on main — no diff)"
"""
