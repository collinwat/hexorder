# Hexorder Git Hooks — managed by lefthook
# See docs/guides/git.md for the conventions these hooks enforce.
#
# Setup: mise install && lefthook install

commit-msg:
  commands:
    validate-format:
      run: |
        msg=$(cat "{1}")
        # Validate conventional commit format: type(scope): summary
        if ! echo "$msg" | head -1 | grep -qE '^(feat|fix|refactor|test|docs|chore|style)\((unit|cell|hex_grid|camera|game_system|editor_ui|ontology|rules_engine|scripting|shortcuts|persistence|settings|undo_redo|map_gen|mechanic_reference|export|contracts|project)\): .+$'; then
          echo ""
          echo "ERROR: Commit message does not match required format."
          echo ""
          echo "  Expected: <type>(<scope>): <summary>"
          echo ""
          echo "  Types:  feat | fix | refactor | test | docs | chore | style"
          echo "  Scopes: unit | cell | hex_grid | camera | game_system | editor_ui | ontology | rules_engine | scripting | shortcuts | persistence | settings | undo_redo | map_gen | mechanic_reference | export | contracts | project"
          echo ""
          echo "  Rules:"
          echo "    - Imperative mood, lowercase, no trailing period"
          echo "    - Max 72 characters on subject line"
          echo ""
          echo "  Got: $(head -1 "{1}")"
          echo ""
          exit 1
        fi
        # Validate subject line length (max 72 characters)
        subject=$(head -1 "{1}")
        if [ ${#subject} -gt 72 ]; then
          echo ""
          echo "ERROR: Subject line exceeds 72 characters (${#subject} chars)."
          echo "  Got: $subject"
          echo ""
          exit 1
        fi
    cargo-lock-guard:
      run: |
        msg=$(head -1 "{1}")
        if git diff --cached --name-only | grep -q '^Cargo\.lock$'; then
          if ! echo "$msg" | grep -qE '^chore\(project\): update dependencies'; then
            echo ""
            echo "NOTICE: Cargo.lock is staged."
            echo ""
            echo "  If you ran 'cargo update', revert it — feature branches inherit"
            echo "  the parent's Cargo.lock. Undo with: git checkout -- Cargo.lock"
            echo ""
            echo "  If this change is intentional (version bump, new dependency in"
            echo "  Cargo.toml), this notice is safe to ignore."
            echo ""
          fi
        fi

pre-commit:
  parallel: true
  commands:
    gitleaks:
      run:
        mise exec -- gitleaks protect --staged --no-banner --baseline-path .gitleaks-baseline.json
    compile:
      run: cargo check --quiet
    fmt:
      run: cargo fmt --all -- --check
    prettier:
      run: prettier --check .
